<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solar Market Trend Analyzer</title>

    <!-- ADDED: Chart.js library for creating dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .card h3 {
        color: #4a5568;
        margin-bottom: 15px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .icon {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      .control-panel {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #4a5568;
      }

      .form-group select,
      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group select:focus,
      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-right: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #cce7ff;
        color: #0c5460;
        border: 1px solid #b8daff;
      }

      .results-section {
        margin-top: 30px;
      }

      .data-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .data-table th,
      .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }

      .data-table th {
        background: #f7fafc;
        font-weight: 600;
        color: #4a5568;
      }

      .data-table tbody tr:hover {
        background: #f7fafc;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .chart-container {
        height: 350px; /* Increased height for better view */
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: relative; /* Needed for Chart.js responsiveness */
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .metric-label {
        opacity: 0.9;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>⚡ Solar Market Trend Analyzer</h1>
        <p>
          Monitor market trends for solar panels, inverters, and battery systems
        </p>
      </div>

      <div class="dashboard">
        <div class="card">
          <h3>
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
              />
            </svg>
            Data Sources
          </h3>
          <div id="sourcesList">
            <p>• Solar industry news sites</p>
            <p>• Government energy databases</p>
            <p>• Market research reports</p>
            <p>• Price comparison platforms</p>
            <p>• Technology forums</p>
          </div>
        </div>

        <div class="card">
          <h3>
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
              />
            </svg>
            Quick Metrics
          </h3>
          <div class="metric-card">
            <div class="metric-value" id="trendsCount">247</div>
            <div class="metric-label">Active Trends Tracked</div>
          </div>
        </div>

        <div class="control-panel">
          <h3>
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"
              />
            </svg>
            Scraping Configuration
          </h3>

          <div class="form-row">
            <div class="form-group">
              <label for="category">Product Category</label>
              <select id="category">
                <option value="solar">Solar Panels</option>
                <option value="inverters">Inverters</option>
                <option value="batteries">Battery Systems</option>
                <option value="all">All Categories</option>
              </select>
            </div>

            <div class="form-group">
              <label for="timeframe">Time Frame</label>
              <select id="timeframe">
                <option value="1d">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="90d">Last 90 Days</option>
              </select>
            </div>

            <div class="form-group">
              <label for="region">Region</label>
              <select id="region">
                <option value="global">Global</option>
                <option value="us">United States</option>
                <option value="eu">Europe</option>
                <option value="asia">Asia-Pacific</option>
                <option value="africa">Africa</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="keywords">Custom Keywords (comma-separated)</label>
              <input
                type="text"
                id="keywords"
                placeholder="lithium battery, solar efficiency, grid tie inverter"
              />
            </div>
          </div>

          <div>
            <button class="btn" onclick="startScraping()">
              Start Analysis
            </button>
            <button class="btn" onclick="exportData()">Export Data</button>
            <button class="btn" onclick="clearData()">Clear Results</button>
          </div>

          <div id="status" class="status"></div>
        </div>
      </div>

      <div class="loading" id="loadingIndicator">
        <div class="spinner"></div>
        <p>Analyzing market data...</p>
      </div>

      <div class="results-section" id="resultsSection" style="display: none">
        <div class="card">
          <h3>Market Trends Analysis</h3>
          <div class="chart-container" id="trendChartContainer">
            <canvas id="chartCanvas"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top: 20px">
          <h3>Recent Market Data</h3>
          <div style="overflow-x: auto">
            <table class="data-table" id="dataTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Product</th>
                  <th>Price Trend</th>
                  <th>Market Sentiment</th>
                  <th>Volume</th>
                  <th>Source</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API Configuration
      const API_BASE_URL = "http://localhost:3000/api";

      let isScrapingActive = false;
      let currentData = [];
      let currentTrends = {};
      let isOfflineMode = false;
      let trendChartInstance = null; // To hold the chart instance

      // Check server connectivity on load
      async function checkServerStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}/status`);
          if (response.ok) {
            showStatus(
              "✅ Backend server connected - Real data available",
              "success"
            );
            isOfflineMode = false;
          } else {
            throw new Error("Server not responding");
          }
        } catch (error) {
          showStatus(
            "⚠️ Backend offline - Using demo mode (full functionality available)",
            "info"
          );
          isOfflineMode = true;
        }
      }

      function showStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = "block";

        setTimeout(() => {
          if (status.textContent === message) {
            status.style.display = "none";
          }
        }, 5000);
      }

      async function startScraping() {
        if (isScrapingActive) return;

        isScrapingActive = true;
        const loadingIndicator = document.getElementById("loadingIndicator");
        const resultsSection = document.getElementById("resultsSection");

        const category = document.getElementById("category").value;
        const timeframe = document.getElementById("timeframe").value;
        const region = document.getElementById("region").value;
        const keywords = document.getElementById("keywords").value;

        loadingIndicator.style.display = "block";
        resultsSection.style.display = "none";

        if (isOfflineMode) {
          showStatus("🔄 Generating analysis with demo data...", "info");
          setTimeout(() => {
            currentData = generateRealisticDemoData(category, region);
            populateResults(currentData);
            loadingIndicator.style.display = "none";
            resultsSection.style.display = "block";
            isScrapingActive = false;
            updateMetrics();
            showStatus(
              "✅ Analysis complete! (Demo mode - install backend for real data)",
              "success"
            );
          }, 2000);
          return;
        }

        showStatus("🔍 Connecting to live market data sources...", "info");

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout for complex analysis

          const response = await fetch(
            `${API_BASE_URL}/analyze?category=${category}&timeframe=${timeframe}®ion=${region}&keywords=${encodeURIComponent(
              keywords
            )}`,
            {
              signal: controller.signal,
            }
          );

          clearTimeout(timeoutId);

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          const result = await response.json();

          if (result.success) {
            currentData = result.data || [];
            currentTrends = result.trends || {};

            populateResults(currentData);
            updateTrendsDisplay(currentTrends);
            updateSummaryDisplay(result.summary);

            showStatus(
              `✅ Live analysis completed! Found ${currentData.length} data points`,
              "success"
            );
          } else {
            throw new Error(result.error || "Analysis failed on the server");
          }
        } catch (error) {
          console.error("API Error:", error);

          if (error.name === "AbortError") {
            showStatus("⏱️ Request timeout - switching to demo mode", "error");
          } else {
            showStatus(
              `🔄 Live data unavailable: ${error.message} - using demo data`,
              "error"
            );
          }

          isOfflineMode = true;
          currentData = generateRealisticDemoData(category, region);
          populateResults(currentData);
        } finally {
          loadingIndicator.style.display = "none";
          resultsSection.style.display = "block";
          isScrapingActive = false;
          updateMetrics();
        }
      }

      function generateRealisticDemoData(category, region) {
        const products = {
          solar: [
            "Monocrystalline Panel",
            "Polycrystalline Panel",
            "Thin Film Panel",
            "Bifacial Panel",
          ],
          inverters: [
            "String Inverter",
            "Power Optimizer",
            "Micro Inverter",
            "Hybrid Inverter",
          ],
          batteries: [
            "Lithium-Ion Battery",
            "LiFePO4 Battery",
            "Lead-Acid Battery",
            "Flow Battery",
          ],
          all: [
            "Solar Panel",
            "String Inverter",
            "Battery Pack",
            "Mounting System",
            "Monitoring System",
          ],
        };
        const sources = [
          "Industry Report",
          "Market Analysis",
          "Reddit",
          "Stock Market",
        ];
        const productList = products[category] || products.all;
        const data = [];
        const today = new Date();

        for (let i = 0; i < 15; i++) {
          const date = new Date(today.getTime() - i * 2 * 24 * 60 * 60 * 1000);
          const change = (Math.random() - 0.5) * 5;

          data.push({
            date: date.toISOString().split("T")[0],
            product:
              productList[Math.floor(Math.random() * productList.length)],
            priceTrend: `${change >= 0 ? "+" : ""}${change.toFixed(1)}%`,
            sentiment: getSentimentFromChange(change),
            volume: (Math.floor(Math.random() * 5000) + 500).toLocaleString(),
            source: sources[Math.floor(Math.random() * sources.length)],
          });
        }
        return data;
      }

      function getSentimentFromChange(change) {
        if (change > 2) return "Very Positive";
        if (change > 1) return "Positive";
        if (change > -1) return "Neutral";
        if (change > -2) return "Negative";
        return "Very Negative";
      }

      function populateResults(data) {
        const dataToUse = data || currentData;
        const tableBody = document.getElementById("dataTableBody");
        tableBody.innerHTML = "";

        if (!dataToUse || dataToUse.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 20px;">No data found for this analysis.</td></tr>';
          if (trendChartInstance) trendChartInstance.destroy(); // Clear chart if no data
          return;
        }

        dataToUse.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.product}</td>
                    <td style="color: ${
                      String(row.priceTrend).startsWith("+")
                        ? "#22c55e"
                        : "#ef4444"
                    }">${row.priceTrend}</td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${getSentimentColor(
                          row.sentiment
                        )}; color: #333;">
                            ${row.sentiment}
                        </span>
                    </td>
                    <td>${row.volume}</td>
                    <td>${row.source}</td>
                `;
          tableBody.appendChild(tr);
        });

        createTrendChart(dataToUse);
      }

      function updateTrendsDisplay(trends) {
        if (!trends || !trends.sentiment) return;
        showStatus(
          `Overall Market Sentiment: ${trends.sentiment.label}`,
          "info"
        );
      }

      function updateSummaryDisplay(summary) {
        if (!summary) return;
        const trendsCount = document.getElementById("trendsCount");
        if (summary.totalDataPoints) {
          trendsCount.textContent = summary.totalDataPoints;
        }
      }

      function getSentimentColor(sentiment) {
        switch (sentiment) {
          case "Very Positive":
            return "#a7f3d0";
          case "Positive":
            return "#bfdbfe";
          case "Neutral":
            return "#e5e7eb";
          case "Negative":
            return "#fecaca";
          case "Very Negative":
            return "#fca5a5";
          default:
            return "#f3f4f6";
        }
      }

      // --- REPLACED: This function now uses Chart.js to draw a real chart --- //
      function createTrendChart(data) {
        const ctx = document.getElementById("chartCanvas").getContext("2d");

        if (trendChartInstance) {
          trendChartInstance.destroy(); // Destroy old chart before creating a new one
        }

        // Process data for the chart
        // We'll group data by date and average the sentiment
        const processedData = {};
        data.forEach((row) => {
          const sentimentValue =
            {
              "Very Negative": -2,
              Negative: -1,
              Neutral: 0,
              Positive: 1,
              "Very Positive": 2,
            }[row.sentiment] || 0;

          if (!processedData[row.date]) {
            processedData[row.date] = { sum: 0, count: 0 };
          }
          processedData[row.date].sum += sentimentValue;
          processedData[row.date].count++;
        });

        const labels = Object.keys(processedData).sort(
          (a, b) => new Date(a) - new Date(b)
        );
        const chartData = labels.map(
          (date) => processedData[date].sum / processedData[date].count
        );

        trendChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Market Sentiment Trend",
                data: chartData,
                fill: true,
                backgroundColor: "rgba(102, 126, 234, 0.2)",
                borderColor: "rgba(102, 126, 234, 1)",
                pointBackgroundColor: "rgba(102, 126, 234, 1)",
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "rgba(102, 126, 234, 1)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function (value, index, values) {
                    const labels = {
                      "-2": "V. Negative",
                      "-1": "Negative",
                      0: "Neutral",
                      1: "Positive",
                      2: "V. Positive",
                    };
                    return labels[value] || "";
                  },
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            hover: {
              mode: "nearest",
              intersect: true,
            },
          },
        });
      }

      function updateMetrics() {
        const trendsCount = document.getElementById("trendsCount");
        const currentCount = parseInt(trendsCount.textContent) || 0;
        const newCount = currentCount + Math.floor(Math.random() * 20) + 5;

        let start = currentCount;
        const end = newCount;
        const duration = 1000;
        const startTime = Date.now();

        function animate() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          trendsCount.textContent = Math.floor(
            start + (end - start) * progress
          );
          if (progress < 1) requestAnimationFrame(animate);
        }
        animate();
      }

      async function exportData() {
        if (!currentData || currentData.length === 0) {
          showStatus("No data to export", "error");
          return;
        }
        showStatus("Preparing data export...", "info");
        const csvContent = generateCSV(currentData);
        downloadCSV(csvContent, "solar_market_data.csv");
        showStatus("Data exported successfully!", "success");
      }

      function generateCSV(data) {
        const headers = [
          "Date",
          "Product",
          "Price Trend",
          "Market Sentiment",
          "Volume",
          "Source",
        ];
        const rows = data.map((row) =>
          headers
            .map(
              (header) =>
                `"${row[header.toLowerCase().replace(" ", "")] || ""}"`
            )
            .join(",")
        );
        return [headers.join(","), ...rows].join("\n");
      }

      function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function clearData() {
        document.getElementById("dataTableBody").innerHTML = "";
        document.getElementById("resultsSection").style.display = "none";
        if (trendChartInstance) {
          trendChartInstance.destroy();
        }
        showStatus("Results cleared", "info");
      }

      window.addEventListener("load", async () => {
        await checkServerStatus();
      });
    </script>
  </body>
</html>
